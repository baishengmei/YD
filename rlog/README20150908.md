### 背景
- dingzq：
> 我也不知道 rlog 最早的 js 代码是哪位高人所著。之前用的都是 CDN 上的[压缩版](http://rlogs.youdao.com/rlog.js)，通常情况下不太可能会去修改这个文件，所以一直也没特意去找她的源码，直到有一天，做词典移动版看天下改版时，有两个需求需要调整 rlog 文件，记得当时问了一圈也没人知道源文件在哪里，还好代码不复杂，后来把 CDN 上的压缩版格式化下就用了，so ......，为了避免后人再遇到类似情况，固在此立碑存念。

- luzhujun：
> 发现原有rlog方法上支持度不够，如必须加载完成才能调用方法，无回调之类；基于后面丁总的版本进行重构了。

本工程最新代码对应的 CDN 地址为：
> `http://shared.ydstatic.com/js/rlog/rlog20150818.js`

### 功能

rlog 是 analyzer 的 web 端（包括 webview）统计代码，用于向 analyzer 后台发送统计 request，类似 google analytics 和百度统计，目前版本支持如下功能：

- 默认开启页面 PV 记录
- 超链接点击记录，默认关闭。注意：由于超链接可能使当前页面发生跳转，记录可能丢失
- 用户自定义事件
- 自定义 key-value
- 默认记录 keyfrom、vendor
- 触屏设备，默认记录第一次触屏事件 ```__rl_event('first-touch')```
- 默认记录 url 后的 hash 参数。例如 ```http://youdao.com/index.html#a=1&b=2```



### 代码安装
#### 部署前说明
* 在部署rlog前，需要先有一个analyzer product id，并安装了rlog的访问分析代码。

#### 安装步骤

* 要使用rlog接口，首先需要js加载前添加一段代码：
```javascript
    var _rlog = _rlog || [];
    _rlog.push(["_setAccount" , "analyzer product id"]);
```

* 然后在页面里面引入js
> `<script defer src="http://shared.ydstatic.com/js/rlog/rlog20150818.js"></script>`


* 在添加了代码后，您的html页面看起来大概是这样的：
```html
    <html>
        <head>
            <!-- 您页面原有的代码 -->
            <script>
            var _rlog = _rlog || [];
            _rlog.push(["_setAccount" , "analyzer product id"]);
            </script>
        </head>
        <body>
            <!-- 您页面原有的代码 -->
            <script defer src="http://shared.ydstatic.com/js/rlog/rlog20150818.js"></script>
        </body>
    </html>
```


### 接口说明

* 设置productId，即analyzer的产品ID
```javascript
    _rlog.push(["_setAccount" , value:String]);

    //等同旧方法
    //__rl_npid=xxx
```

* 设置是否自动发送pageview
```javascript
    _rlog.push(["_setAutoPageview" , value:Boolean]);

    //等同旧方法
    //__rl_pageview=xxx
```



* 手动发送pageview
```javascript
    _rlog.push(["_setAutoPageview" , false]);
    //...

    //先关闭自动发送pageview，否则会重复发送
    _rlog.push(["_trackPageview"]);
```


* 发送额外参数，pageview、每次_trackEvent、_trackCustom都会带上
```javascript
    _rlog.push(["_addPost" , key:String , value:String]);

    //等同旧方法
    //__rl_post.push([key , value]);
```


* 删除额外参数
```javascript
    _rlog.push(["_removePost" , key:String]);
```


* 清空发送额外参数
```javascript
    _rlog.push(["_removePost"]);
```


* 当发送完成pageview后回调
```javascript
    _rlog.push(["_onPageViewFinished" , callback:Function]);
```


* 记录事件
```javascript
    //value：事件值
    //callback：事件发送完成后的回调函数

    _rlog.push(["_trackEvent" , value:String]);

    _rlog.push(["_trackEvent" , value:String , callback:Function]);


    //等同旧方法
    //__rl_event(value)
```

* 自定义发送
```javascript
    //catalog：analyzer对应的catalog
    //value：事件值
    //callback：事件发送完成后的回调函数

    _rlog.push(["_trackCustom" , catalog:String , value:String]);

    _rlog.push(["_trackCustom" , catalog:String , value:String , callback:Function]);
```

* 自动绑定点击事件
```javascript
    <a href="#" data-rlog="video.play">播放</a>
    //与以下效果相同
    _rlog.push(["_trackEvent" , "video.play"]);
```


#### 原有rlog关键参数说明：

- __rl_npid

> product ID，在 analyzer 系统中具有唯一性，必选

- pageview

```javascript
// 手动关闭 pageview 统计（默认打开）
__rl_pageview = false;
```

- click

click 统计会在点击行为触发时，探测节点有无 href 属性，若有，则记录 log

```javascript
// 手动打开 click 统计（默认关闭）
__rl_click = true;
```

- event

```javascript
// event 统计
__rl_event( str );
```

### 相关说明
* 目前为止，仅在 Outfox Wiki 上找到一篇介绍 [rlog (全称：request-logger)](https://dev.corp.youdao.com/outfoxwiki/ToolBox/RequestLoggerFront) 比较详细的文章，下面摘录其部分个人觉得 web 前端开发中需要用到的内容，供参考。